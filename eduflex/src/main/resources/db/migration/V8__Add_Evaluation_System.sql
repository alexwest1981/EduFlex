-- Course Evaluation System Migration

-- 1. Evaluation Templates
CREATE TABLE IF NOT EXISTS evaluation_templates (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description VARCHAR(1000),
    is_system_template BOOLEAN DEFAULT FALSE,
    created_by_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_template_author FOREIGN KEY (created_by_id) REFERENCES app_users(id)
);

-- 2. Evaluation Questions (Rich structure)
CREATE TABLE IF NOT EXISTS evaluation_template_questions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    template_id BIGINT NOT NULL,
    question_text VARCHAR(1000) NOT NULL,
    question_type VARCHAR(50) NOT NULL, -- LIKERT, NPS, TEXT, EMOJI, MULTIPLE_CHOICE
    options_json TEXT, -- For multiple choice options
    order_index INTEGER DEFAULT 0,
    is_required BOOLEAN DEFAULT TRUE,
    CONSTRAINT fk_question_template FOREIGN KEY (template_id) REFERENCES evaluation_templates(id) ON DELETE CASCADE
);

-- 3. Evaluation Instances (Specific activations for courses)
CREATE TABLE IF NOT EXISTS evaluation_instances (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    course_id BIGINT NOT NULL,
    template_id BIGINT NOT NULL,
    title VARCHAR(255),
    start_date TIMESTAMP,
    end_date TIMESTAMP,
    status VARCHAR(50) DEFAULT 'DRAFT', -- DRAFT, ACTIVE, COLLECTING, CLOSED
    ai_summary TEXT, -- Result from Gemini analysis
    response_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_instance_course FOREIGN KEY (course_id) REFERENCES courses(id),
    CONSTRAINT fk_instance_template FOREIGN KEY (template_id) REFERENCES evaluation_templates(id)
);

-- 4. Evaluation Responses (Anonymized)
CREATE TABLE IF NOT EXISTS evaluation_responses_v2 (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    instance_id BIGINT NOT NULL,
    student_id_hash VARCHAR(255), -- For anonymity but preventing duplicates
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_response_instance FOREIGN KEY (instance_id) REFERENCES evaluation_instances(id) ON DELETE CASCADE
);

-- 5. Evaluation Answers
CREATE TABLE IF NOT EXISTS evaluation_answers_v2 (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    response_id BIGINT NOT NULL,
    question_id BIGINT NOT NULL,
    answer_value TEXT, -- The actual response
    CONSTRAINT fk_answer_response FOREIGN KEY (response_id) REFERENCES evaluation_responses_v2(id) ON DELETE CASCADE,
    CONSTRAINT fk_answer_question FOREIGN KEY (question_id) REFERENCES evaluation_template_questions(id)
);

-- Index for analytics
CREATE INDEX IF NOT EXISTS idx_eval_instance_course ON evaluation_instances(course_id);
CREATE INDEX IF NOT EXISTS idx_eval_response_instance ON evaluation_responses_v2(instance_id);

-- Seed Skolverket Default Template
INSERT INTO evaluation_templates (name, description, is_system_template, created_at) 
SELECT 'Skolverket Standardutvärdering', 'Standardmallen för kursutvärdering enligt Skolverkets riktlinjer.', true, CURRENT_TIMESTAMP
WHERE NOT EXISTS (SELECT 1 FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering');

INSERT INTO evaluation_template_questions (template_id, question_text, question_type, order_index, is_required) 
SELECT id, 'Hur väl stämde kursens innehåll med målen?', 'LIKERT', 0, true FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering';

INSERT INTO evaluation_template_questions (template_id, question_text, question_type, order_index, is_required) 
SELECT id, 'Hur upplevde du de pedagogiska metoderna?', 'LIKERT', 1, true FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering';

INSERT INTO evaluation_template_questions (template_id, question_text, question_type, order_index, is_required) 
SELECT id, 'Har du fått tillräckligt med stöd under kursen?', 'LIKERT', 2, true FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering';

INSERT INTO evaluation_template_questions (template_id, question_text, question_type, order_index, is_required) 
SELECT id, 'Hur var arbetsbelastningen?', 'LIKERT', 3, true FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering';

INSERT INTO evaluation_template_questions (template_id, question_text, question_type, order_index, is_required) 
SELECT id, 'Hur bra var studiematerialet?', 'LIKERT', 4, true FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering';

INSERT INTO evaluation_template_questions (template_id, question_text, question_type, order_index, is_required) 
SELECT id, 'Vad var det bästa med kursen?', 'TEXT', 5, true FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering';

INSERT INTO evaluation_template_questions (template_id, question_text, question_type, order_index, is_required) 
SELECT id, 'Vad kan förbättras?', 'TEXT', 6, true FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering';

INSERT INTO evaluation_template_questions (template_id, question_text, question_type, order_index, is_required) 
SELECT id, 'Hur sannolikt är det att du skulle rekommendera denna kurs till en vän?', 'NPS', 7, true FROM evaluation_templates WHERE name = 'Skolverket Standardutvärdering';
