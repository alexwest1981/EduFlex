-- Migration to repair missing Adaptive Learning tables in tenant schemas
-- This script is idempotent to safely run across all environments

-- 1. Create adaptive_learning_profiles if missing
CREATE TABLE IF NOT EXISTS adaptive_learning_profiles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL,
    visual_score INTEGER DEFAULT 50,
    auditory_score INTEGER DEFAULT 50,
    kinesthetic_score INTEGER DEFAULT 50,
    pace_preference VARCHAR(20) DEFAULT 'MODERATE',
    struggle_areas TEXT,
    strength_areas TEXT,
    last_analyzed TIMESTAMP,
    CONSTRAINT fk_profile_user FOREIGN KEY (user_id) REFERENCES app_users(id)
);

-- 2. Create adaptive_recommendations if missing
CREATE TABLE IF NOT EXISTS adaptive_recommendations (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    type VARCHAR(50) NOT NULL,
    ai_reasoning TEXT,
    status VARCHAR(50) DEFAULT 'NEW',
    priority_score INTEGER DEFAULT 50,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_rec_user FOREIGN KEY (user_id) REFERENCES app_users(id)
);

-- 3. Ensure reasoning_trace exists in adaptive_recommendations
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name='adaptive_recommendations' 
                     AND column_name='reasoning_trace'
                     AND table_schema = current_schema()) THEN
        ALTER TABLE adaptive_recommendations ADD COLUMN reasoning_trace TEXT;
    END IF;
END $$;

-- 4. Create ai_audit_logs if missing
CREATE TABLE IF NOT EXISTS ai_audit_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    action_type VARCHAR(100) NOT NULL,
    model_used VARCHAR(100),
    prompt_hash VARCHAR(64),
    input_context TEXT,
    output_result TEXT,
    reasoning_trace TEXT,
    audit_metadata TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_ai_audit_user ON ai_audit_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_ai_audit_action ON ai_audit_logs(action_type);
