spring.application.name=eduflex
server.port=8080
# Listen on all network interfaces for LAN access
server.address=0.0.0.0

# Allow bean definition overriding to handle custom configurations
# Allow bean definition overriding to handle custom configurations
spring.main.allow-bean-definition-overriding=true

# Public URL for generating external links (e.g. OnlyOffice)
app.url=https://www.eduflexlms.se

# --- Static Resources (OnlyOffice) ---
spring.web.resources.static-locations=classpath:/static/
spring.mvc.static-path-pattern=/**
# Disable caching for dev (0)
spring.web.resources.cache.period=0

# --- PostgreSQL Settings ---
spring.datasource.url=jdbc:postgresql://localhost:5432/eduflex
spring.datasource.username=postgres
spring.datasource.password=gotland81
spring.datasource.driver-class-name=org.postgresql.Driver

# --- JPA / Hibernate ---
spring.jpa.hibernate.ddl-auto=update
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.show-sql=false
spring.jpa.open-in-view=true
# Ensure schema is created before running data.sql
spring.jpa.defer-datasource-initialization=true

# --- MULTI-TENANCY (DISABLED TEMPORARILY) ---
# Uncomment these lines when frontend supports X-Tenant-ID header
# spring.jpa.properties.hibernate.multiTenancy=SCHEMA
# spring.jpa.properties.hibernate.multi_tenant_connection_provider=com.eduflex.backend.config.tenant.SchemaMultiTenantConnectionProvider
# spring.jpa.properties.hibernate.tenant_identifier_resolver=com.eduflex.backend.config.tenant.TenantIdentifierResolver

# Flyway settings - baseline-on-migrate helps with existing tables
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.out-of-order=true

# Encoding
spring.datasource.connectionProperties=useUnicode=true;characterEncoding=utf-8

# File upload settings

# --- Upload Directory ---
file.upload-dir=/app/uploads

# --- MINIO ---
minio.url=${MINIO_URL:http://localhost:9000}
minio.public-url=http://localhost:9000
minio.access-key=${MINIO_ACCESS_KEY:minioadmin}
minio.secret-key=${MINIO_SECRET_KEY:minioadmin}
minio.bucket=${MINIO_BUCKET:eduflex}

# --- REDIS CACHE ---
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.timeout=60000

# --- ACTUATOR / MONITORING ---
management.endpoints.web.exposure.include=health,info,prometheus,metrics
management.endpoint.health.show-details=always
management.metrics.tags.application=${spring.application.name}

# --- OAUTH2 / SSO ---
# Google
spring.security.oauth2.client.registration.google.client-id=placeholder-id
spring.security.oauth2.client.registration.google.client-secret=placeholder-secret
spring.security.oauth2.client.registration.google.scope=openid,profile,email,https://www.googleapis.com/auth/userinfo.profile,https://www.googleapis.com/auth/userinfo.email
spring.security.oauth2.client.registration.google.redirect-uri={baseUrl}/login/oauth2/code/{registrationId}
spring.security.oauth2.client.registration.google.client-name=Google

# GitHub
spring.security.oauth2.client.registration.github.client-id=placeholder-id
spring.security.oauth2.client.registration.github.client-secret=placeholder-secret
spring.security.oauth2.client.registration.github.scope=read:user,user:email
spring.security.oauth2.client.registration.github.redirect-uri={baseUrl}/login/oauth2/code/{registrationId}
spring.security.oauth2.client.registration.github.client-name=GitHub

# Keycloak (Enterprise SSO)
spring.security.oauth2.client.registration.keycloak.client-id=eduflex-app
spring.security.oauth2.client.registration.keycloak.client-secret=eduflex-secret-key-change-in-production
spring.security.oauth2.client.registration.keycloak.scope=openid,profile,email,roles
spring.security.oauth2.client.registration.keycloak.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.keycloak.redirect-uri={baseUrl}/login/oauth2/code/{registrationId}
spring.security.oauth2.client.registration.keycloak.client-name=Keycloak

# IMPORTANT: All URLs use localhost:8180 since that's what Keycloak returns in metadata
# DO NOT use issuer-uri with OIDC discovery - it causes issuer mismatch between localhost:8180 and keycloak:8080
# Authorization URI is used by the BROWSER - must be localhost
spring.security.oauth2.client.provider.keycloak.authorization-uri=http://localhost:8180/realms/eduflex/protocol/openid-connect/auth
# Token/UserInfo/JWK are called by the BACKEND - use localhost:8180 when running locally
spring.security.oauth2.client.provider.keycloak.token-uri=http://localhost:8180/realms/eduflex/protocol/openid-connect/token
spring.security.oauth2.client.provider.keycloak.user-info-uri=http://localhost:8180/realms/eduflex/protocol/openid-connect/userinfo
spring.security.oauth2.client.provider.keycloak.jwk-set-uri=http://localhost:8180/realms/eduflex/protocol/openid-connect/certs
spring.security.oauth2.client.provider.keycloak.user-name-attribute=preferred_username

# OAuth2 Resource Server (for validating Keycloak JWT tokens)
# issuer-uri must match token issuer (localhost:8180)
# issuer-uri must match token issuer (localhost:8180) because that's what Keycloak reports via KC_HOSTNAME
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8180/realms/eduflex
# jwk-set-uri must be reachable by BACKEND - use localhost:8180 when running locally
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=http://localhost:8180/realms/eduflex/protocol/openid-connect/certs

# SSO Mode toggle (keycloak, internal, or hybrid)
eduflex.auth.mode=hybrid

# JWT Security (Internal & OnlyOffice)
eduflex.jwt.secret=eduflex_secure_secret_key_32_chars_
eduflex.jwt.expiration=86400000

# --- DEBUG LOGGING ---
logging.level.root=INFO
logging.level.com.eduflex.backend=DEBUG
logging.level.org.springframework.security=DEBUG

logging.level.org.springframework.web=DEBUG
logging.level.com.fasterxml.jackson=DEBUG

# --- LOGGING TO FILE (For Admin Dashboard) ---
# --- LOGGING TO FILE (For Admin Dashboard) ---
# logging.file.name=/app/logs/server.log
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %msg%n

# Prevent infinite loop in WebSocket logging (SimpLogging logs every message sent, causing a loop with LogTailer)
logging.level.org.springframework.web.SimpLogging=INFO
logging.level.org.springframework.messaging=INFO

# --- MULTIPART LIMITS ---
spring.servlet.multipart.max-file-size=500MB
spring.servlet.multipart.max-request-size=500MB

# --- GEMINI / AI QUIZ GENERATION ---
gemini.api.key=${GEMINI_API_KEY:}
gemini.model=gemini-2.0-flash
gemini.timeout=60

# Gemini / Google Cloud AI Configuration (Managed by SystemConfigService)

# AI Quiz Settings
ai.quiz.max-questions=15
ai.quiz.default-questions=5
# --- KAFKA ---
spring.kafka.bootstrap-servers=${SPRING_KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer
spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer
spring.kafka.consumer.group-id=eduflex-group
spring.kafka.consumer.auto-offset-reset=earliest
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.JsonDeserializer
spring.kafka.consumer.properties.spring.json.trusted.packages=com.eduflex.backend.event
spring.kafka.admin.fail-fast=false
